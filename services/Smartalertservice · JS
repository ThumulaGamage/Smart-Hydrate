import { ref, get } from 'firebase/database';
import { auth } from '../config/firebaseConfig';

// Graceful notification import
let Notifications = null;
let notificationsAvailable = false;

try {
  Notifications = require('expo-notifications');
  notificationsAvailable = true;
} catch (error) {
  console.log('‚ö†Ô∏è Notifications not available');
}

// Initialize database
let database;
try {
  const { getDatabase } = require('firebase/database');
  database = getDatabase(auth.app);
} catch (e) {
  console.error("Failed to initialize database:", e);
}

// Track sent alerts to prevent duplicates
const sentAlerts = new Set();
const lastAlertTimes = {};

/**
 * Send a smart alert notification (call this manually when conditions are detected)
 * @param {string} alertType - Type of alert: 'low_water', 'hot_water', 'cold_water', 'drink_reminder', 'disconnected'
 * @param {object} data - Additional data for the alert
 */
export const sendSmartAlert = async (alertType, data = {}) => {
  if (!notificationsAvailable) {
    console.log('‚ö†Ô∏è Notifications not available');
    return false;
  }

  try {
    // Check if master notifications are enabled
    if (auth.currentUser) {
      const settingsRef = ref(database, `users/${auth.currentUser.uid}/settings`);
      const settingsSnapshot = await get(settingsRef);
      
      if (settingsSnapshot.exists()) {
        const settings = settingsSnapshot.val();
        if (settings.pushNotifications === false) {
          console.log('üîï Push notifications disabled by user');
          return false;
        }
      }
    }

    const now = Date.now();
    const ALERT_COOLDOWN = 1800000; // 30 minutes

    // Check cooldown
    const lastTime = lastAlertTimes[alertType];
    if (lastTime && (now - lastTime) < ALERT_COOLDOWN) {
      console.log(`‚è≥ Alert ${alertType} still in cooldown`);
      return false;
    }

    let title, body, priority, sound;

    switch (alertType) {
      case 'low_water':
        title = 'üö® Bottle Running Low';
        body = 'Your bottle is running low! Time for a refill.';
        priority = Notifications.AndroidNotificationPriority.HIGH;
        sound = true;
        break;

      case 'hot_water':
        title = 'üå°Ô∏è Water Temperature High';
        body = 'Water is quite warm. Consider adding ice for better taste.';
        priority = Notifications.AndroidNotificationPriority.DEFAULT;
        sound = true;
        break;

      case 'cold_water':
        title = '‚ùÑÔ∏è Refreshingly Cold';
        body = 'Your water is nice and cold! Perfect for hydration.';
        priority = Notifications.AndroidNotificationPriority.LOW;
        sound = false;
        break;

      case 'drink_reminder':
        title = '‚è∞ Hydration Reminder';
        body = "It's been over an hour since your last drink. Stay hydrated!";
        priority = Notifications.AndroidNotificationPriority.HIGH;
        sound = true;
        break;

      case 'disconnected':
        title = 'üì° Bottle Disconnected';
        body = 'Your smart bottle is not connected. Connect to track your hydration.';
        priority = Notifications.AndroidNotificationPriority.DEFAULT;
        sound = true;
        break;

      default:
        console.log(`‚ö†Ô∏è Unknown alert type: ${alertType}`);
        return false;
    }

    // Send notification
    await Notifications.scheduleNotificationAsync({
      content: {
        title,
        body,
        sound,
        priority,
        data: {
          type: 'smart_alert',
          alertType,
          ...data,
        },
      },
      trigger: null, // Send immediately
    });

    // Update tracking
    lastAlertTimes[alertType] = now;
    sentAlerts.add(alertType);

    console.log(`‚úÖ Sent ${alertType} alert`);
    return true;

  } catch (error) {
    console.error(`‚ùå Error sending ${alertType} alert:`, error);
    return false;
  }
};

/**
 * Send a progress alert notification
 * @param {string} alertType - 'goal_achieved', 'almost_there', 'halfway', 'good_start', 'low_progress'
 * @param {number} progress - Progress percentage
 */
export const sendProgressAlert = async (alertType, progress) => {
  if (!notificationsAvailable) return false;

  try {
    // Check if master notifications are enabled
    if (auth.currentUser) {
      const settingsRef = ref(database, `users/${auth.currentUser.uid}/settings`);
      const settingsSnapshot = await get(settingsRef);
      
      if (settingsSnapshot.exists()) {
        const settings = settingsSnapshot.val();
        if (settings.pushNotifications === false) {
          console.log('üîï Push notifications disabled by user');
          return false;
        }
      }
    }

    const today = new Date().toISOString().split('T')[0];
    const alertKey = `${alertType}_${today}`;

    // Only send once per day per milestone
    if (sentAlerts.has(alertKey)) {
      console.log(`‚è≥ Progress alert ${alertType} already sent today`);
      return false;
    }

    let title, body, priority, sound;

    switch (alertType) {
      case 'goal_achieved':
        title = 'üéâ Goal Achieved!';
        body = "Congratulations! You've reached your daily hydration goal!";
        priority = Notifications.AndroidNotificationPriority.HIGH;
        sound = true;
        break;

      case 'almost_there':
        title = 'üöÄ Almost There!';
        body = `You're ${progress.toFixed(0)}% towards your goal. Keep it up!`;
        priority = Notifications.AndroidNotificationPriority.DEFAULT;
        sound = true;
        break;

      case 'halfway':
        title = 'üíß Halfway Point!';
        body = `You're ${progress.toFixed(0)}% towards your daily goal. Great progress!`;
        priority = Notifications.AndroidNotificationPriority.DEFAULT;
        sound = false;
        break;

      case 'good_start':
        title = 'üëç Good Start!';
        body = `You've consumed ${progress.toFixed(0)}% of your daily goal. Keep going!`;
        priority = Notifications.AndroidNotificationPriority.LOW;
        sound = false;
        break;

      case 'low_progress':
        title = 'üí¶ Hydration Check';
        body = `You've only consumed ${progress.toFixed(0)}% of your daily goal. Remember to stay hydrated!`;
        priority = Notifications.AndroidNotificationPriority.DEFAULT;
        sound = true;
        break;

      default:
        console.log(`‚ö†Ô∏è Unknown progress alert type: ${alertType}`);
        return false;
    }

    // Send notification
    await Notifications.scheduleNotificationAsync({
      content: {
        title,
        body,
        sound,
        priority,
        data: {
          type: 'progress_alert',
          alertType,
          progress,
        },
      },
      trigger: null,
    });

    // Mark as sent for today
    sentAlerts.add(alertKey);
    lastAlertTimes[alertKey] = Date.now();

    console.log(`‚úÖ Sent ${alertType} progress alert (${progress.toFixed(0)}%)`);
    return true;

  } catch (error) {
    console.error(`‚ùå Error sending ${alertType} progress alert:`, error);
    return false;
  }
};

/**
 * Clear alert tracking (call this at midnight or on new day)
 */
export const clearAlertTracking = () => {
  const today = new Date().toISOString().split('T')[0];
  
  // Remove old date-based alerts
  Array.from(sentAlerts).forEach(alert => {
    if (alert.includes('_20')) { // Contains a date
      const alertDate = alert.split('_').pop();
      if (alertDate !== today) {
        sentAlerts.delete(alert);
        delete lastAlertTimes[alert];
      }
    }
  });
  
  console.log('üîÑ Cleared old alert tracking');
};

/**
 * Reset cooldown for a specific alert type
 * @param {string} alertType 
 */
export const resetAlertCooldown = (alertType) => {
  delete lastAlertTimes[alertType];
  sentAlerts.delete(alertType);
  console.log(`üîÑ Reset cooldown for ${alertType}`);
};

export default {
  sendSmartAlert,
  sendProgressAlert,
  clearAlertTracking,
  resetAlertCooldown,
};